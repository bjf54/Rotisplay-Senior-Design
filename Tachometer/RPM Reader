// ECE 1896 Senior Design
// Team 5 - Rotisplay
// This program reads the RPM of a magnet coming within and out of range of a Hall Effect Sensor

// Set digital pin 2 as the hall pin
int sensorPin = 2;

// Set number of rotation trips for RPM reading (higher improves accuracy)
float rotationThresh = 100.0;

void setup() 
{
  // Initialize serial communication at 9600 bits per second
  Serial.begin(9600);

  // Make the hall pin an input
  pinMode(sensorPin, INPUT);
}

void loop() 
{
  // Preallocate values for tachometer
  float rotationCount = 1.0;
  float startTime = micros();
  bool onState = false;

  // Count the number of times the hall sensor is tripped,
  // but without double counting during the same trip
  while(true)
  {

    // The Hall Effect sensor reads LOW when a magnet is within range
    if(digitalRead(sensorPin) == 0)
    {
      if(onState == false)
      {
        onState = true;
        rotationCount += 1.0;
      }
    }

    else
    {
      onState = false;
    }

    if (rotationCount >= rotationThresh)
    {
      break;
    }
  }

  // Calculate time passed for rotation
  float endTime = micros();
  float timePassed = ((endTime - startTime)/1000000.0);

  // Print information about time passed
  Serial.print("Time Passed: ");
  Serial.print(timePassed);
  Serial.print(" s");

  // Calculate the RPM value
  float rpmValue = (rotationCount / timePassed) * 60.0;

  // Print information about the RPM
  Serial.println("RPM: ");
  Serial.print(rpmValue);

  // Delay in between reads for stability
  delay(1);
}
